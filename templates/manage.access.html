{% extends "master.html" %}
{% block content %}

<!-- New / update user modal -->
<form action="/manage/access/user" method="POST" class="m-0" id="userDetailForm">
    <div class="modal fade" id="userDetailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userDetailLabel">New User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="username" class="col-form-label">Username</label>
                <input type="text" class="form-control" id="username" name="username" placeholder="johns" required>
              </div>
              <div class="mb-3">
                <label for="email" class="col-form-label">Email</label>
                <input type="text" class="form-control" id="email" name="email" placeholder="johns@example.com" required>
              </div>
              <div class="mb-3" id="password-section">
                <label for="password" class="col-form-label">Password</label> <button type="button" class="btn btn-primary btn-sm m-0 p-0 px-1" onclick="document.getElementById('password').value = randomPassword()">Random</button>
                <input type="text" class="form-control" id="password" name="password" placeholder="Password" required>
              </div>
              <div class="mb-3">
                <label for="message-text" class="col-form-label">Role</label>
                <select class="selectpicker form-control" multiple data-live-search="true" title="Role(s)" data-style="" data-style-base="form-control" data-live-search-placeholder="Search..." data-width="auto" name="roles" id="roles">
                    <option>Admin</option>
                    <option>Spectator</option>
                    <option>Blue</option>
                    <option>Red</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="message-text" class="col-form-label">Assessments</label>
                <select class="selectpicker form-control" multiple data-live-search="true" title="Assessment(s)" data-style="" data-style-base="form-control" data-live-search-placeholder="Search..." data-width="auto" name="assessments" id="assessments">
					{% for assessment in assessments %}
                    	<option>{{ assessment.name }}</option>
					{% endfor %}
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" id="userDetailButton">Create</button>
          </div>
        </div>
      </div>
    </div>
</form>

<!-- Confirm delete user -->
<div class="modal fade" id="delUserModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Delete User</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="mb-3" id="delUserWarning">ERROR</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
				<button type="button" class="btn btn-danger" id="hard-delete-button" onclick="delUser()">Delete</button>
			</div>
		</div>
	</div>
</div>

<!-- Password Reset -->
<form action="/manage/access/user/" method="POST" class="m-0" id="pwdResetForm">
    <div class="modal fade" id="pwdResetModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="pwdresetModalLabel">Change Password for ERROR</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="recipient-name" class="col-form-label">New Password</label>
                <input type="password" class="form-control" id="recipient-name" name="password" placeholder="Password" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Change</button>
          </div>
        </div>
      </div>
    </div>
</form>

<div class="m-2 mt-0">
	<div id="toolbar">
		<p class="d-inline-block" style="font-size:1.3em;margin: 0 10px 0 5px;font-weight:bold">Access</p>
		<button id="add" class="btn btn-primary" onclick="newUserModal()">
			New User
		</button>
	</div>
	<table data-toggle="table" data-toolbar="#toolbar" data-search="true" data-show-search-clear-button="true" id="user-table">

		<thead>
			<tr class="tr-class-1">
				<th data-field="id" data-visible="false">ID</th>
				<th data-field="username" data-valign="middle" data-sortable="true">Username</th>
				<th data-field="email">Email</th>
				<th data-field="roles" data-sortable="true">Roles</th>
				<th data-field="last-login" data-sortable="true">Last Login</th>
				<th data-field="assessments" data-sortable="true">Assessments</th>
				<th data-field="actions" data-sortable="true" class="text-center">Actions</th>
			</tr>
		</thead>

		<tbody>
			<!-- Sample admin read row -->
			{% for user in users %}
			<tr data-title="bootstrap table" data-object='{"key": "value"}'>
				<td>{{ user.id}}</td>
				<td>{{ user.username}}</td>
				<td>{{ user.email}}</td>
				<td>{{ user.roles | map(attribute='name') | join(', ') or "-" }}</td>
				<td>{{ user.lastauth or "Never authed"}}</td>
				<td>{{ user.assessments | map(attribute='name') | join(', ') }}</td>
				<td>
					<div class="btn-group btn-group-sm" role="group">
						<!-- Delete, password reset, rights -->
						<button type="button" class="btn btn-primary py-0" title="Edit" onclick="editUserModal(this)">
							<i class="bi-pencil-fill">&zwnj;</i>
						</button>
						<button type="button" class="btn btn-warning py-0" title="Password reset" onclick="pwdResetModal(this)">
							<i class="bi-key-fill">&zwnj;</i>
						</button>
						<button type="button" class="btn btn-disabled py-0" title="API Keys" disabled style="cursor: not-allowed; pointer-events: all !important;">
							<i class="bi-code-slash">&zwnj;</i>
						</button>
						<button type="button" class="btn btn-danger py-0" title="Delete" onclick="delUserModal(this)">
							<i class="bi-trash">&zwnj;</i>
						</button>
					</div>
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</div>

<script>

	var $table = $("#user-table")[0]
	var rowData = null

	$(function () {
		$('#user-table').bootstrapTable()
		$('#engagement-selector').selectpicker()
	})

	function newUserModal(e) {
		$('#userDetailForm').attr('action', '/manage/access/user') 
		$('#userDetailLabel').text("New User")
		$('#userDetailButton').text("Create")
		$('#password-section').show()
		$('#password').attr('required', 'required');
		$('#userDetailForm #username').val("")
		$('#userDetailForm #email').val("")
		$('#userDetailForm #roles').selectpicker('val', "");
		$('#userDetailForm #assessments').selectpicker('val', "");
		$('#userDetailModal').modal('show')
	}

	function editUserModal(e) {
		let i = $(e).closest("tr").data("index")
		rowData = $('#user-table').bootstrapTable('getData')[i]
		$('#userDetailForm').attr('action', '/manage/access/user/' + rowData.id) 
		$('#userDetailLabel').text("Update Details For " + rowData.username)
		$('#userDetailButton').text("Update")
		$('#password-section').hide()
		$('#password').removeAttr('required');
		$('#userDetailForm #username').val(rowData.username)
		$('#userDetailForm #email').val(rowData.email)
		$('#userDetailForm #roles').selectpicker('val', rowData.roles.split(", "));
		$('#userDetailForm #assessments').selectpicker('val', rowData.assessments.split(", "));
		$('#userDetailModal').modal('show')
	}

	function pwdResetModal(e) {
		let i = $(e).closest("tr").data("index")
		rowData = $('#user-table').bootstrapTable('getData')[i]
		$('#pwdResetForm').attr('action', '/manage/access/user/' + rowData.id) 
		$('#pwdresetModalLabel').text("Reset Password For " + rowData.username)
		$('#pwdResetModal').modal('show')
	}

	function delUserModal(e) {
		let i = $(e).closest("tr").data("index")
		rowData = $('#user-table').bootstrapTable('getData')[i]
		$('#delUserForm').attr('action', '/manage/access/user/' + rowData.id) 
		$('#delUserWarning').text("Really Delete " + rowData.username + "?")
		$('#delUserModal').modal('show')
	}

	function delUser(e) {
		$.ajax({
			url: '/manage/access/user/' + rowData.id,
			type: 'DELETE',
			success: function(result) {
				location.reload();
			}
		});
	}

</script>
<script src="/static/scripts/random_pass.js"></script>

{% endblock %}